<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>golinks</title>
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    <link rel="stylesheet" href="/static/styles.css?v=5">
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
</head>
<body>
    <nav class="navbar">
        <div class="navbar-container">
            <div class="navbar-brand">
                <h1>go<span class="accent">links</span></h1>
            </div>
            <div class="navbar-nav">
                <a href="{{.BaseURL}}/homepage/" class="nav-link active">Home</a>
                <a href="{{.BaseURL}}/setup/" class="nav-link">Setup</a>
            </div>
        </div>
    </nav>
    
    {{if .Missing}}
        <div id="failure" class="status-message">
            <span>‚ö†Ô∏è</span>
            <div>Unable to find a shortcut for the query <code>{{.Missing}}</code></div>
        </div>
    {{else if .Success}}
        <div id="success" class="status-message">
            <span>‚úÖ</span>
            <div>Added keyword <code>{{.Success}}</code></div>
        </div>
    {{else if .Failure}}
        <div id="failure" class="status-message">
            <span>‚ùå</span>
            <div>Adding keyword <code>{{.Failure}}</code> failed: {{.Reason}}</div>
        </div>
    {{end}}

    <div class="constrained-width">
        <p>
            If you're not yet setup with GoLinks then you should follow the guide 
            <a href="{{.BaseURL}}/setup/">here</a>.
        </p>
        <p>
            Your search engine should now read: <code>{{.BaseURL}}/query/%s</code>
        </p>

        <h2>‚ûï Add new keyword</h2>
        <form id="linkForm" 
              hx-post="{{.BaseURL}}/update/" 
              hx-trigger="submit"
              hx-target="#form-result"
              hx-swap="innerHTML">
            <div id="formData">
                <input type="text" name="word" placeholder="Keyword" required>
                <input type="text" name="link" placeholder="URL" required>
                <input type="submit" value="Add Link">
            </div>
        </form>
        
        <div id="form-result" class="fade-in"></div>


        {{if .AllKeywords}}
        <h2>üîé Full keyword list</h2>
        <p class="text-muted">
            If you're needing inspiration, here are the current listed keywords. 
            Use <code>{*}</code> in a URL for variable links and space separated queries, 
            like <code>go google cats</code>.
        </p>
        <table id="all-keywords">
            <thead>
                <tr>
                    <th>Keyword</th>
                    <th>URL</th>
                    <th>Created On</th>
                </tr>
            </thead>
            <tbody>
                {{range .AllKeywords}}
                <tr>
                    <td><code>{{.Word}}</code></td>
                    <td class="url">{{urlify .Link}}</td>
                    <td>{{.CreatedAt.Format "2006-01-02"}}</td>
                </tr>
                {{end}}
            </tbody>
        </table>
        {{end}}
    </div>

    <script>
        // Form handling with HTMX
        document.getElementById('linkForm').addEventListener('htmx:afterRequest', function(event) {
            const form = event.target;
            const result = document.getElementById('form-result');
            
            if (event.detail.successful) {
                // Success - redirect to show success message
                const word = form.querySelector('input[name="word"]').value;
                window.location.href = window.location.pathname + "?success=" + encodeURIComponent(word);
            } else {
                // Error - show specific error message from server
                const errorText = event.detail.xhr.responseText || 'An error occurred. Please try again.';
                showErrorMessage(errorText);
            }
        });

        // Form validation - basic checks only
        document.getElementById('linkForm').addEventListener('submit', function(event) {
            const word = this.querySelector('input[name="word"]').value.trim();
            const link = this.querySelector('input[name="link"]').value.trim();
            
            // Clear any previous error messages
            document.getElementById('form-result').innerHTML = '';
            
            // Only check for empty fields - let server handle URL validation
            if (!word) {
                event.preventDefault();
                showErrorMessage('Please enter a keyword.');
                return;
            }
            
            if (!link) {
                event.preventDefault();
                showErrorMessage('Please enter a URL.');
                return;
            }
            
            if (word.endsWith('/')) {
                event.preventDefault();
                showErrorMessage('Keywords ending in \'/\' are not supported.');
                return;
            }
        });
        
        // Helper function to show error messages
        function showErrorMessage(message) {
            document.getElementById('form-result').innerHTML = '<div class="error-message">' + message + '</div>';
        }

        // Auto-hide status messages after 5 seconds
        setTimeout(function() {
            const statusMessages = document.querySelectorAll('#success, #failure');
            statusMessages.forEach(function(msg) {
                msg.style.transition = 'opacity 0.5s ease';
                msg.style.opacity = '0';
                setTimeout(function() {
                    msg.style.display = 'none';
                }, 500);
            });
        }, 5000);
    </script>
</body>
</html>
